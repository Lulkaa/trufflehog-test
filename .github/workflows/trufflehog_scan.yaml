name: Trufflehog scanning 

on:
  pull_request:
    branches:
      - main
      - master

jobs:
  secret-scan:
    name: TruffleHog Secret Detection
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 
      
      - name: Run TruffleHog scan
        run: |
          echo "ğŸ” Scanning entire repository history for secrets..."
          
          docker run --rm -v "$PWD:/scan" \
            trufflesecurity/trufflehog:latest \
            git file:///scan \
            --json \
            --no-update \
            --fail > scan_results.json 2>&1 || true
          
          # ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚Ğ¸ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¸ Ğ² ĞºĞ¾Ğ½ÑĞ¾Ğ»Ñ–
          if [ -s scan_results.json ]; then
            echo "::group::TruffleHog Results"
            cat scan_results.json | jq -r 'select(.Raw != null) | 
              "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
              "  Found Secret:\n" +
              "  Detector: \(.DetectorName)\n" +
              "  File: \(.SourceMetadata.Data.Git.file)\n" +
              "  Line: \(.SourceMetadata.Data.Git.line)\n" +
              "  Commit: \(.SourceMetadata.Data.Git.commit)\n" +
              "  Raw: \(.Raw)\n" +
              "  Verified: \(.Verified)\n" +
              "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            ' || cat scan_results.json
            echo "::endgroup::"
            
            # ĞŸÑ–Ğ´Ñ€Ğ°Ñ…ÑƒĞ²Ğ°Ñ‚Ğ¸ ĞºÑ–Ğ»ÑŒĞºÑ–ÑÑ‚ÑŒ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¸Ñ… ÑĞµĞºÑ€ĞµÑ‚Ñ–Ğ²
            SECRET_COUNT=$(cat scan_results.json | jq -s 'length')
            echo "::error:: Found $SECRET_COUNT secret(s) in repository!"
            exit 1
          else
            echo " No secrets detected!"
          fi
